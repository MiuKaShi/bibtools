#!/bin/bash
# Print citation read from bibtex file

FMTSTR='$authors, $journal $volume$number$pages ($year)\n$title\n$link\n'

function usage() {
    echo "$(basename $0): Print citation read from bibtex file"
    echo ""
    echo "USAGE: $(basename $0) [-f str] bibfiles"
    echo "Options:"
    echo "  -h      print this help"
    echo "  -u      unabbreviated forenames"
    echo "  -s      author forenames first"
    echo "  -o      one line citation"
    echo "  -b      brief one line citation"
    echo "  -f str  use format string 'str'"
    echo "Default format string:"
    echo "  '$FMTSTR'"
    echo "Field names:"
    echo "  authors, fauthor (first author), title, journal,"
    echo "  volume, number, pages, year, doi, url, link, key"
    exit $1
}
if [ $# -lt 1 ]; then usage 1; fi

# Default options.
FULLFIRSTNAME=0 # Abbreviate first and middle names.
LASTNAMEFIRST=1 # Print family name, first names in author list.

# Parse command line options.
for arg; do
    # With option '-h' print usage and exit.
    if [[ "$arg" == "-h" ]]; then usage 0; fi
    # With option '-u' print full forenames.
    if [[ "$arg" == "-u" ]]; then FULLFIRSTNAME=1; fi
    # With option '-s' print forenames first.
    if [[ "$arg" == "-s" ]]; then LASTNAMEFIRST=0; fi
    # With option '-o' print one line citation.
    if [[ "$arg" == "-o" ]]; then FMTSTR='$authors, $journal, $volume$number$pages ($year)'; fi
    # With option '-b' print one line citation with first author only.
    if [[ "$arg" == "-b" ]]; then FMTSTR='$fauthor, $journal, $volume$number$pages ($year)'; fi
done

if [[ "$1" == "-f" ]]
then
    [[ "$#" -ge 2 ]] && FMTSTR="$2" \
        || echo "Missing argument to option '-f'!" >/dev/stderr
    shift 2 || shift 1
fi


TMPDIR=$(mktemp -d)

# Function to replace latex by utf8 characters
function latex_to_utf() { # echo text | latex_to_utf
    sed \
          -e '
              s/\\"{a}/ä/g
              s/\\"{o}/ö/g
              s/\\"{u}/ü/g
              s/\\"{i}/ı̈/g
              s/\\"{n}/n̈/g
              s/\\"{A}/Ä/g
              s/\\"{O}/Ö/g
              s/\\"{U}/Ü/g
              s/\\H{o}/ő/g
              s/\\H{u}/ű/g
              s/\\H{O}/Ő/g
              s/\\H{U}/Ű/g
              s/\\^{a}/â/g
              s/\\^{e}/ê/g
              s/\\^{i}/î/g
              s/\\^{o}/ô/g
              s/\\^{u}/û/g
              s/\\^{s}/ŝ/g
              s/\\^{A}/Â/g
              s/\\^{E}/Ê/g
              s/\\^{I}/Î/g
              s/\\^{O}/Ô/g
              s/\\^{U}/Û/g
              s/\\`{a}/à/g
              s/\\`{e}/è/g
              s/\\c{c}/ç/g
              s/\\k{a}/ą/g
              s/\\k{e}/ę/g
              s/\\k{A}/Ą/g
              s/\\k{E}/Ę/g
              s/\\r{a}/å/g
              s/\\r{A}/Å/g
              s/\\v{c}/č/g
              s/\\v{r}/ř/g
              s/\\v{s}/š/g
              s/\\v{z}/ž/g
              s/\\v{C}/Č/g
              s/\\v{R}/Ř/g
              s/\\v{S}/Š/g
              s/\\v{Z}/Ž/g
              s/\\~{a}/ã/g
              s/\\~{n}/ñ/g
              s/\\~{A}/Ã/g
              s/\\~{N}/Ñ/g
              s/{\\ss}/ß/g
              s/{\\l}/gł/g
              s/{\\L}/gŁ/g
              ' \
          -e "
              s/\\\\'{a}/á/g
              s/\\\\'{e}/é/g
              s/\\\\'{i}/í/g
              s/\\\\'{o}/ó/g
              s/\\\\'{u}/ú/g
              s/\\\\'{c}/ć/g
              s/\\\\'{n}/ń/g
              s/\\\\'{y}/ý/g
              s/\\\\'{A}/Á/g
              s/\\\\'{E}/É/g
              s/\\\\'{I}/Í/g
              s/\\\\'{O}/Ó/g
              s/\\\\'{U}/Ú/g
              "
}

# Function to remove latex macros such as \v{Z}.
# It treats nesting of curly braces up to third order.
function remove_macros() { # echo text | remove_macros
    sed -e 's/\\[a-z][a-z]*{\([^{}]*\)}/\1/g' \
        -e 's/\\[a-z][a-z]*{\([^{}]*{[^{}]*}[^{}]*\)}/\1/g' \
        -e 's/\\[a-z][a-z]*{\([^{}]*{[^{}]*{[^{}]*}[^{}]*}[^{}]*\)}/\1/g' \

}

# Function to get a field value from the first bib entry.
function getvalue() { # getvalue fieldname filename
    pattern="^ *$(sed 's/\(.\)/[\u\1\l\1]/' <<< $1) *="
    awk -v pattern="$pattern" '/^@/{nr+=1; if(nr>1) exit}
{if ($0 ~ pattern) print $0}' "$2" | grep -o '{[^{].*' | head -n1 \
    | latex_to_utf \
    | remove_macros \
    | sed -e 's/^{ *//;s/:*[}, ]*$//' \
          -e 's/[{}"\]//g'
}


# Iterate bib files (possibly '-' for standard input).
for bibfile in "$@"
do
    # Skip options.
    test "$bibfile" != "-u" || continue
    test "$bibfile" != "-s" || continue
    test "$bibfile" != "-o" || continue
    test "$bibfile" != "-b" || continue

    # Replace »name.pdf« by »name.pdf.bib«.
    bibfile=$(sed 's/\.pdf$/&.bib/' <<< "$bibfile")

    # Skip if not a regular file or standard input.
    test -f "$bibfile" -o "$bibfile" = "-" || {
        [[ "$bibfile" =~ ^- ]] \
            && echo "$(basename $0): $bibfile: Unknown option" >/dev/stderr \
            || echo "$(basename $0): $bibfile: File not found" >/dev/stderr;
        continue
    }
    filenr=$(($filenr + 1))

    # Split file to single entry files in temporary directory.
    awk -v dir=$TMPDIR -v fnr=$filenr '
BEGIN{nr=0}
/^@/{nr+=1}
{if (nr) print $0 > sprintf("%s/%d-%d", dir, fnr, nr)}' "$bibfile"
done


# Iterate temporary single entry bibtex files.
find "$TMPDIR"/ -mindepth 1 -type f | while read bibfile
do
    # Obtain field values.
    if grep -q @Book "$bibfile"
    then
        journal=$(getvalue Title "$bibfile")
        volume=$(getvalue Publisher "$bibfile")
    else
        journal=$(getvalue Journal "$bibfile" | sed -r 's/^The //')
        volume=$(getvalue Volume "$bibfile")
    fi
    title=$(getvalue Title "$bibfile")
    number=$(getvalue Number "$bibfile" | sed 's/./.&/')
    pages=$(getvalue Pages "$bibfile" | sed 's/-.*//;s/^/, /')
    year=$(getvalue Year "$bibfile")
    doi=$(getvalue Doi "$bibfile")
    url=$(getvalue Url "$bibfile")
    key=$(bib-keyinsert -p "$bibfile")

    # Format list of authors as »Name, A. B., ...«.
    # - remove curly brackets, replace "A" by "A."
    # - split author list to one line per author
    # - put family name in front (\2, \1)
    #   (with workaround for French name Le Xxx)
    # - abbreviate first name
    # - abbreviate all middle names
    ABBRFNAME="'s/\(, [A-Z]\)[^. ][^ -]*/\1./'"
    test $FULLFIRSTNAME -eq 1 && ABBRFNAME="''"
    SWAPNAMES="'s/\([^,]*\), \(.*\)/\2 \1/'"
    test $LASTNAMEFIRST -eq 1 && SWAPNAMES="''"
    authors=$(getvalue Author "$bibfile" \
        | sed \
            -e 's/[{}]//g' \
            -e 's/\(\<[A-Z]\>\)\.*/\1./g' \
            -e 's/ and /\n/g' \
            -e 's/~/ /g' \
        | sed \
            -e 's/\<Le\> \([A-Z][^ ]*$\)/le \1/g' \
            -e '/,/!s/\(.*[A-Z][^ ]*\) \(.*\) *$/\2, \1/' \
            -e 's/^\<le\> \([A-Z]\)/Le \1/g' \
        | eval sed $ABBRFNAME \
        | sed \
            -e ':x;s/\([A-Z]\.[ -][A-Z]\)[^. ][^ -]*/\1./;tx' \
        | eval sed $SWAPNAMES \
        | sed ':x;N;s/\n/, /;tx'
        )

    # Derived values.
    fauthor=$(sed 's/,.*//' <<< "$authors")
    if sed 's/, [A-Z]\.[^,]*//' <<< "$authors" | grep -q ,
    then
        # Add 'et al.' in case of several authors.
        fauthor="$fauthor et al."
    fi
    test -n "$doi" && link="https://doi.org/$doi"
    test -n "$url" && link="$url"

    # Print citation.
    eval echo -e "\"$FMTSTR\"" | sed 's/  */ /g;s/, ,/,/g;s/, (/ (/g'
done

# Remove temporary directory.
rm -rf "$TMPDIR"
