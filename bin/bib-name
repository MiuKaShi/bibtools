#!/bin/bash
# Print rename commands for bibtex files
#
# A letter suffix to the year in the citation key is kept
# or may be selected with the filename as 'file.bib:a'.

function usage() {
    echo "$(basename $0): Print rename commands for bibtex files"
    echo ""
    echo "Journal names are abbreviated before creating the file name."
    echo "To gain speed rather than stability, the option -s can be used."
    echo ""
    echo "USAGE: $(basename $0) bibfiles[:letter]"
    echo "Optional letter suffix for year."
    echo "Options:"
    echo "  -h  print this help"
    echo "  -s  skip journal abbreviation"
    exit $1
}
if [ $# -lt 1 ]; then usage 1; fi

# Default options.
SKIPJ=0 # Skip journal abbreviation (faster).

# Parse command line options.
for arg; do
    # With option '-h' print usage and exit.
    if [[ "$arg" == "-h" ]]; then usage 0; fi
    # With option '-s' skip journal abbreviation.
    if [[ "$arg" == "-s" ]]; then SKIPJ=1; fi
done


# Function to replace latex by utf8 characters
function latex_to_utf() { # echo text | latex_to_utf
    sed \
          -e '
              s/\\"{a}/ä/g
              s/\\"{o}/ö/g
              s/\\"{u}/ü/g
              s/\\"{i}/ı̈/g
              s/\\"{n}/n̈/g
              s/\\"{A}/Ä/g
              s/\\"{O}/Ö/g
              s/\\"{U}/Ü/g
              s/\\H{o}/ő/g
              s/\\H{u}/ű/g
              s/\\H{O}/Ő/g
              s/\\H{U}/Ű/g
              s/\\^{a}/â/g
              s/\\^{e}/ê/g
              s/\\^{i}/î/g
              s/\\^{o}/ô/g
              s/\\^{u}/û/g
              s/\\^{s}/ŝ/g
              s/\\^{A}/Â/g
              s/\\^{E}/Ê/g
              s/\\^{I}/Î/g
              s/\\^{O}/Ô/g
              s/\\^{U}/Û/g
              s/\\`{a}/à/g
              s/\\`{e}/è/g
              s/\\c{c}/ç/g
              s/\\k{a}/ą/g
              s/\\k{e}/ę/g
              s/\\k{A}/Ą/g
              s/\\k{E}/Ę/g
              s/\\r{a}/å/g
              s/\\r{A}/Å/g
              s/\\v{c}/č/g
              s/\\v{r}/ř/g
              s/\\v{s}/š/g
              s/\\v{z}/ž/g
              s/\\v{C}/Č/g
              s/\\v{R}/Ř/g
              s/\\v{S}/Š/g
              s/\\v{Z}/Ž/g
              s/\\~{a}/ã/g
              s/\\~{n}/ñ/g
              s/\\~{A}/Ã/g
              s/\\~{N}/Ñ/g
              s/{\\ae}/æ/g
              s/{\\oe}/œ/g
              s/{\\ss}/ß/g
              s/{\\l}/gł/
              s/{\\L}/gŁ/
              s/{\\o}/gø/
              s/{\\O}/gØ/
              ' \
          -e "
              s/\\\\'{a}/á/g
              s/\\\\'{e}/é/g
              s/\\\\'{i}/í/g
              s/\\\\'{o}/ó/g
              s/\\\\'{u}/ú/g
              s/\\\\'{c}/ć/g
              s/\\\\'{n}/ń/g
              s/\\\\'{y}/ý/g
              s/\\\\'{A}/Á/g
              s/\\\\'{E}/É/g
              s/\\\\'{I}/Í/g
              s/\\\\'{O}/Ó/g
              s/\\\\'{U}/Ú/g
              "
}

# Function to remove latex macros such as \v{Z}.
# It treats nesting of curly braces up to third order.
function remove_macros() { # echo text | remove_macros
    sed -e 's/\\[a-z][a-z]*{\([^{}]*\)}/\1/g' \
        -e 's/\\[a-z][a-z]*{\([^{}]*{[^{}]*}[^{}]*\)}/\1/g' \
        -e 's/\\[a-z][a-z]*{\([^{}]*{[^{}]*{[^{}]*}[^{}]*}[^{}]*\)}/\1/g' \

}

# Function to get a field value from the first bib entry.
function getvalue() { # getvalue fieldname filename
    pattern="^ *$(sed 's/\(.\)/[\u\1\l\1]/' <<< $1) *="
    awk -v pattern="$pattern" '/^@/{nr+=1; if(nr>1) exit}
{if ($0 ~ pattern) print $0}' "$2" | grep -o '{[^{].*' | head -n1 \
    | latex_to_utf \
    | remove_macros \
    | sed -e 's/^{ *//;s/:*[}, ]*$//' \
          -e 's/[{}"\]//g'
}

# Function to replace non ascii characters / remove undesired characters.
function replace_chars() { # replace_chars string
    echo "$@" | sed \
        -e 'y/áéíóúć/aeiouc/;y/àèìòù/aeiou/' \
        -e 'y/ÁÉÍÓÚĆ/AEIOUC/;y/ÀÈÌÒÙ/AEIOU/' \
        -e 'y/âêîôûĉŝẑ/aeioucsz/;y/ÂÊÎÔÛĈŜẐ/AEIOUCSZ/' \
        -e 'y/čřšž/crsz/;y/ČŘŠŽ/CRSZ/' \
        -e 'y/ãñ/an/;y/ÃÑ/AN/' \
        -e 'y/å/a/;y/Å/A/' \
        -e 'y/ç/c/;y/Ç/C/' \
        -e 'y/ąęđł/aedl/;y/ĄĘĐŁ/AEDL/' \
        -e 's/ı̈/i/g;s/n̈/n/g' \
        -e 's/ä/ae/g;s/ö/oe/g;s/ü/ue/g;s/ø/oe/' \
        -e 's/Ä/Ae/g;s/Ö/Oe/g;s/Ü/Ue/g;s/Ø/Oe/' \
        -e 's/ő/oe/g;s/ű/ue/g' \
        -e 's/Ő/Oe/g;s/Ű/Ue/g' \
        -e 's/æ/ae/g;s/œ/oe/g;s/ß/ss/g' \
        -e 's/&//g' \
        -e 'y/‐−–/---/' \
        -e "s/[']//g;s/-$//"
}

# Iterate bib files.
for bibfile in "$@"
do
    # Skip options.
    test "$bibfile" != "-s" || continue

    # Possibly select letter suffix from 'filename:letter'.
    letter=$(grep -o ':[a-z]*$' <<< "$bibfile" | head -n1)
    test -z "$letter" || bibfile=$(sed 's/:[a-z]*$//' <<< "$bibfile")

    # Remove trailing »./« for stable filename comparison.
    bibfile=$(sed 's:^\./::' <<< "$bibfile")

    # Replace »name.pdf« by »name.pdf.bib«.
    bibfile=$(sed 's/\.pdf$/&.bib/' <<< "$bibfile")
    pdffile=$(sed -n '/\.pdf\.bib$/{s//.pdf/;p}' <<< "$bibfile")

    # Skip if not a regular file.
    test -f "$bibfile" || {
        [[ "$bibfile" =~ ^- ]] \
            && echo "$(basename $0): $bibfile: Unknown option" >/dev/stderr \
            || echo "$(basename $0): $bibfile: File not found" >/dev/stderr;
        continue
    }

    # Skip multi record files.
    nr=`sed -r '/@([A-Za-z]+)* *\{.*,/!d' "$bibfile" | wc -l`
    if [ $nr -gt 1 ]
    then
        echo "WARNING: Do not insert keys into multi record file '$bibfile'." >/dev/stderr
        continue
    fi

    # Obtain field values.
    doi=$(getvalue Doi "$bibfile")

    fauthor=$(getvalue Author "$bibfile" \
        | sed 's/ and .*//;s/ *,.*//;s/.*[ ~]//')
    echo "# author: $fauthor"

    if [ $SKIPJ -eq 1 ]
    then
        # Quick key creation without journal abbreviation.
        journal=$(getvalue Journal "$bibfile")
    else
        # Stable key creation with journal abbreviation.
        journal=$(getvalue Journal "$bibfile" | xargs bib-jabbr -j)
    fi
    journal=$(echo "$journal" \
        | sed -r \
              -e 's/[,:].*//;s/OF //;s/\<[Tt][Hh][Ee]\>//' \
              -e 's/([A-Za-z]+) */\1/g;s/[a-z. ]|\\*&//g' \
              -e 's/ *[[({].*//')
    echo "# journal: $journal"

    year=$(getvalue Year "$bibfile")
    echo "# year: $year"

    # If not from 'filename:letter', search letter in actual citation key.
    if [ -n "$year" ] && [ -z "$letter" ]
    then
        letter=$(grep '^@' "$bibfile" | head -n1 \
            | grep -o "${year}[a-z]*[,: ]" | grep -o "[a-z]*" | head -n1)
    else
        letter="${letter#:}" # Remove preceding colon.
    fi

    # New file names.
    newpdfname="$(dirname "$bibfile")/${fauthor}_${year}${letter}_${journal}"
    newpdfname="${newpdfname#./}"
    newpdfname=$(replace_chars "$newpdfname").pdf
    newbibname="${newpdfname}.bib"

    # Assure safe quoting.
    qnewpdfname="${newpdfname//\"/\\\"}"
    qbibfile="${bibfile//\"/\\\"}"
    qpdffile="${pdffile//\"/\\\"}"

    # Print doi link.
    if [ -n "$doi" ]
    then
        echo "# http://doi.org/${doi}"
    fi

    # Print rename command for bib file.
    if [ "${bibfile}" != "${newbibname}" ] && [ ! -e "${newbibname}" ]
    then
        echo "mv -i \"${qbibfile}\" \"${qnewpdfname}.bib\"  # ${qnewpdfname}"
    elif [ "${bibfile}" != "${newbibname}" ] && [ -e "${newbibname}" ]
    then
        echo "# WARNING: Do not move '${bibfile}' to existing '${newbibname}'." >/dev/stderr
    else
        echo "# ${newbibname}"
    fi

    test -f "$pdffile" || continue

    # Print rename command for pdf file.
    if [ "${pdffile}" != "${newpdfname}" ] && [ ! -e "${newpdfname}" ]
    then
        echo "mv -i \"${qpdffile}\" \"${qnewpdfname}\""
    elif [ "${pdffile}" != "${newpdfname}" ] && [ -e "${newpdfname}" ]
    then
        echo "# WARNING: Do not move '${pdffile}' to existing '${newpdfname}'." >/dev/stderr
    else
        echo "# ${newpdfname}"
    fi
done
