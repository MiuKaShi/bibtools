#!/bin/bash
# Unite bibfiles with sorted keys

function usage() {
    echo "Unite bibfiles with sorted keys"
    echo "USAGE: $(basename $0) [-r] bibfiles"
    echo "Options:"
    echo "  -h  print this help"
    echo "  -r  newest entries first (by year)"
    exit $1
}
if [ $# -lt 1 ]; then usage 1; fi

# Default options.
RYEAR= # Show newest entries last.

# Parse command line options.
for arg; do
    # With option '-h' print usage and exit.
    if [[ "$arg" == "-h" ]]; then usage 0; fi
done

# With option '-r' show newest entries first.
if [[ "$1" == "-r" ]]; then
    RYEAR=-r
    shift
fi


# Concatenate and sort all files.
sed '1s/^/\n\n/;$s/$/\n@/;N;s/\([^\n]\)\n@/\1\n\n@/;P;D' "$@" \
    | awk '
BEGIN {
    RS="\n\n@"
    ORS="\n"
    FS="\n"
    OFS="\0"
}
{
    # Print one line records with fields delimited by NUL.
    for(i=1; i<=NF; i++) {
        # Add empty field in the beginning.
        printf("%s%s", OFS, $i)
    }
    printf(ORS)
}
' \
    | sed '/^\x00/!d;/^\x00\x00$/d;/^\x00\x00\x00/d' \
    | sed 'h;s/^\x00[^{]*{//;s/,\x00.*//;s/:/ /;s/\([a-z][a-z]*\)\( [^\x00]*\)/\2\1/;s/[0-9][0-9]* / &/;G;s/\n/\x00/' \
    | sort -sf -k3,3 \
    | sort -sn -k2,2 $RYEAR \
    | sort -sf -k1,1 \
    | sed 's/^[^\x00]*\x00\x00/\x00/' \
    | awk '
BEGIN {
    RS="\n"
    ORS="\n"
    FS="\0"
    OFS="\n"
}
{
    # Print sorted records with initial newlines.
    printf("@")
    for (i=2; i<=NF; i++) {
        # Omit empty field added above.
        printf("%s%s", $i, OFS)
    }
    printf(ORS)
}
' \
    | grep -v '^@$'
